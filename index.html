<!DOCTYPE html>
<html lang="en">
<head>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress/nprogress.css">
<script src="https://cdn.jsdelivr.net/npm/nprogress/nprogress.js"></script>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Пример рисования</title>
<style>
  #canvas {
    border: 1px solid black;
  }
</style>
</head>

<body>

<script src="https://telegram.org/js/telegram-web-app.js?1"></script>

  <h1>Рисование на холсте</h1>
  <canvas id="canvas" width="400" height="300"></canvas>
  <button id="saveButton">Сохранить</button>
  <script>
    const canvas = document.getElementById("canvas");
    const context = canvas.getContext("2d");
    let painting = false;

    canvas.addEventListener("mousedown", startPosition);
    canvas.addEventListener("mouseup", endPosition);
    canvas.addEventListener("mousemove", draw);

    function startPosition(e) {
      painting = true;
      draw(e);
    }

    function endPosition() {
      painting = false;
      context.beginPath();
    }

    function draw(e) {
      if (!painting) return;
      context.lineWidth = 5;
      context.lineCap = "round";
      context.strokeStyle = "black";

      context.lineTo(e.clientX - canvas.offsetLeft, e.clientY - canvas.offsetTop);
      context.stroke();
      context.beginPath();
      context.moveTo(e.clientX - canvas.offsetLeft, e.clientY - canvas.offsetTop);
    }

    
  </script>

  <script>
    let tg = Telegram.WebApp;
    tg.expand()
    let savebtn = document.getElementById('saveButton')
    
    savebtn.addEventListener("click", async () => {
      const image = canvas.toDataURL("image/png");
      const base64Image = image.split(",")[1];
      console.log("Base64 Image:", base64Image);

      const url = "https://b909-176-120-204-75.ngrok-free.app"; // Замените на ваш URL

      const uuid = generateUUID(); // Генерируем UUID
      const data = {
        base64Image: base64Image,
        uuid: uuid
      };

      NProgress.start(); // Начать показ прогресс-бара

      try {
        // Отправляем данные на сервер
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          console.log("Image successfully uploaded.");
        } else {
          console.log("Image upload failed.");
        }
      } catch (error) {
        console.error("Error during upload:", error);
      }

      NProgress.done(); // Завершить показ прогресс-бара
      tg.sendData(uuid)
      tg.close();
    });

    function generateUUID() {
      return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0,
          v = c === "x" ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

  </script>
</body>
</html>
